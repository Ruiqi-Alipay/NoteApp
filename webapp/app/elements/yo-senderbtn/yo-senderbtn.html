<link rel="import" href="../../../components/polymer/polymer.html">
<link rel="import" href="../../../components/paper-fab/paper-fab.html">
<link rel="import" href="../../../components/paper-spinner/paper-spinner.html">
<link rel="import" href="../../../components/paper-toast/paper-toast.html">
<link rel="import" href="../yo-http/yo-http.html">
<link rel="import" href="../yo-groupdialog/yo-groupdialog.html">

<polymer-element name="yo-senderbtn">
	<template layout horizontal end>
		<link rel="stylesheet" href="yo-senderbtn.css">
		<paper-spinner active?="{{sending}}"></paper-spinner>
		<paper-fab icon="send" class="editFab green" title="发送" on-click="{{sendMessage}}" hidden?="{{sending}}"></paper-fab>
		<yo-http id="yoHttp"></yo-http>
		<paper-toast id="toast" class="capsule" text="日志内容不可为空" style="padding-right: 60px;"></paper-toast>
        <yo-groupdialog id="confirmDialog" on-action-cancel="{{onActionCanceled}}" on-action-confirm="{{onActionConfirm}}"></yo-groupdialog>
	</template>
	<script>
	(function () {
		Polymer({
			ready: function () {
				this.sending = false;
			},
			sendMessage: function () {
				this.sending = true;
				var tagbar = document.getElementById('yo-tagbar');
				var useTags = tagbar.getSelectedTags();

				var html = quill.getHTML();
				var text = quill.getText();

				if (text.replace(/ /g,'').length < 2) {
					this.sending = false;
					this.$.toast.show();
					return;
				}

				this.$.yoHttp.makeRequest(this, function (scope, messages, updatedGroup) {
					scope.sending = false;
					toggleEditor(false);
					document.getElementById('yo-app').onSendFinished(scope.draft, messages, updatedGroup);
				}, './api/group/' + this.draft.groupId + '/message', 'POST', undefined, {
					userid: this.draft.userId,
					text: text,
					html: html,
					tags: useTags,
					draftId: this.draft.id
				}, 'application/json');
			},
			createDrift: function (text, html) {
				this.driftText = text;
				this.driftHtml = html;
				if (this.draft.id) {
					this.$.confirmDialog.subject = '更新草稿？';
				} else {
					this.$.confirmDialog.subject = '是否保存到草稿？';
				}
				this.$.confirmDialog.showDialog(false);
			},
    		onActionConfirm: function () {
				var tagbar = document.getElementById('yo-tagbar');
				var useTags = tagbar.getSelectedTags();

				this.$.yoHttp.makeRequest(this, function (scope, draft) {
					scope.$.confirmDialog.closeDialog();
					toggleEditor(false);
					document.getElementById('yo-app').onSaveDraftFinished(draft);
				}, './api/user/' + this.draft.userId + '/draft' + (this.draft.id ? '/' + this.draft.id : ''), 'POST', undefined, {
					text: this.driftText,
					html: this.driftHtml,
					groupId: this.draft.groupId,
					tags: useTags
				}, 'application/json');      
    		},
    		onActionCanceled: function () {
      			toggleEditor(false);
    		}
		});
	})();
	</script>
</polymer-element>












